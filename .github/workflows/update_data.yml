name: Update Trump Data (JSON Hunt)
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests

      - name: JSON Data Hunt
        run: |
          cat <<EOF > analyzer.py
          import requests
          import json
          import datetime
          import random
          import re
          import time

          # Vi testar TVÅ adresser.
          # 1. Huvudsidan (där datan kan ligga gömd i script-taggar)
          url_main = "https://rollcall.com/factbase/trump/topic/social/?platform=all&sort=date&sort_order=desc"
          # 2. En potentiell API-endpoint som Factbase ofta använder
          url_api = "https://factba.se/json/json-recent.json"

          post_count = 0
          minutes_since_last = 999
          status = "simulated"
          fetched_success = False
          
          # Hämta UTC-tid nu
          now_utc = datetime.datetime.utcnow()

          print("--- STARTAR JÄKTA PÅ DATA ---")

          # FÖRSÖK 1: Direkt API (Om den lever)
          try:
              print(f"Testar API: {url_api}")
              headers = {'User-Agent': 'Mozilla/5.0'}
              resp = requests.get(url_api, headers=headers, timeout=10)
              if resp.status_code == 200:
                  print("API Svarade! Analyserar JSON...")
                  data = resp.json()
                  # Här måste vi gissa strukturen, men ofta är det en lista
                  # Vi letar efter datumsträngar i hela blobben
                  raw_text = json.dumps(data)
              else:
                  print("API fungerade inte, går vidare till Huvudsidan.")
                  raw_text = ""
          except:
              print("API-anrop misslyckades.")
              raw_text = ""

          # FÖRSÖK 2: Huvudsidan (Deep Scan efter Epoch-tid)
          if not raw_text:
              try:
                  print(f"Hämtar HTML från: {url_main}")
                  headers = {
                      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                  }
                  resp = requests.get(url_main, headers=headers, timeout=20)
                  raw_text = resp.text
              except Exception as e:
                  print(f"Kunde inte hämta HTML: {e}")

          # ANALYS: Leta efter Unix Tidsstämplar (Epoch)
          # Tider år 2026 börjar på 17... (t.ex. 1765432100)
          # Vi letar efter siffror som börjar på 17 följt av 8 siffror (sekunder) eller 11 siffror (millisekunder)
          
          print("Letar efter dolda tidsstämplar (Epoch)...")
          
          # Regex för sekunder (10 siffror, börjar på 17) -> År 2024-2026
          epoch_matches = re.findall(r'(17\d{8})', raw_text)
          
          # Regex för millisekunder (13 siffror, börjar på 17)
          epoch_ms_matches = re.findall(r'(17\d{11})', raw_text)

          all_timestamps = []

          # Hantera sekunder
          for ts in epoch_matches:
              try:
                  dt = datetime.datetime.utcfromtimestamp(int(ts))
                  all_timestamps.append(dt)
              except: continue

          # Hantera millisekunder
          for ts in epoch_ms_matches:
              try:
                  dt = datetime.datetime.utcfromtimestamp(int(ts) / 1000)
                  all_timestamps.append(dt)
              except: continue

          print(f"Hittade {len(all_timestamps)} potentiella tidsstämplar.")

          found_minutes = []

          for post_date in all_timestamps:
              # Räkna skillnad
              diff = now_utc - post_date
              diff_minutes = int(diff.total_seconds() / 60)
              
              # Filtrera: Måste vara i dåtid (pos) men mindre än 1 år gammalt
              # Vi accepterar små negativa värden (-60 min) pga tidszoner och justerar dem
              if diff_minutes > -300 and diff_minutes < 500000:
                  
                  # Justering för Eastern Time (om tidsstämpeln var lokal tid men tolkades som UTC)
                  # Om inlägget ser ut att vara "300 minuter i framtiden" (-300), så är det nog ET.
                  if diff_minutes < 0: 
                      adjusted_minutes = diff_minutes + 300 # Lägg på 5h
                      if adjusted_minutes < 0: adjusted_minutes = 0 # Fortfarande framtid? Sätt till nu.
                      found_minutes.append(adjusted_minutes)
                  else:
                      found_minutes.append(diff_minutes)

          if found_minutes:
              found_minutes.sort()
              minutes_since_last = found_minutes[0]
              post_count = sum(1 for m in found_minutes if m < 60)
              status = "live"
              fetched_success = True
              print(f"SUCCESS: Senaste aktivitet: {minutes_since_last} min sedan.")
          else:
              print("Inga giltiga tidsstämplar hittades.")


          # --- SIMULERING (Fallback) ---
          if not fetched_success:
              status = "estimated"
              # Samma gamla trygga AI-modell
              roll = random.randint(0, 100)
              if roll < 65: 
                  post_count = 0
                  minutes_since_last = random.randint(65, 400)
              elif roll < 90:
                  post_count = random.randint(1, 2)
                  minutes_since_last = random.randint(10, 45)
              else: 
                  post_count = random.randint(3, 6)
                  minutes_since_last = random.randint(1, 9)

          # Spara
          output = {
              "postCount": post_count,
              "minutesSince": minutes_since_last,
              "status": status,
              "lastUpdated": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          }

          with open('data.json', 'w') as f:
              json.dump(output, f)
          EOF

          python analyzer.py

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Epoch Hunt Update" || exit 0
          git push
