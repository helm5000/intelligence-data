name: Update Trump Data
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Fetch and Analyze Real Time Data
        run: |
          cat <<EOF > analyzer.py
          import urllib.request
          import json
          import datetime
          import random
          import sys
          from xml.dom import minidom

          # Vi definierar två olika vägar in (Proxies)
          proxy_1 = "https://api.allorigins.win/get?url=https://truthsocial.com/@realDonaldTrump.rss"
          proxy_2 = "https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Ftruthsocial.com%2F%40realDonaldTrump.rss"

          post_count_last_hour = 0
          status = "estimated" # Startvärde
          fetched_success = False

          now = datetime.datetime.utcnow()
          print(f"Nuvarande tid (UTC): {now}")

          # --- FÖRSÖK 1: AllOrigins (XML) ---
          if not fetched_success:
              try:
                  print("Testar Proxy 1 (AllOrigins)...")
                  # Vi ger den 30 sekunder nu istället för 10
                  req = urllib.request.Request(proxy_1, headers={'User-Agent': 'Mozilla/5.0'})
                  response = urllib.request.urlopen(req, timeout=30)
                  data = json.loads(response.read())
                  rss_content = data['contents']
                  
                  # Tolka XML
                  dom = minidom.parseString(rss_content)
                  items = dom.getElementsByTagName('item')
                  
                  real_count = 0
                  for item in items:
                      try:
                          pub_date_str = item.getElementsByTagName('pubDate')[0].firstChild.data
                          # Klipp av tidszonen för att undvika format-fel
                          pub_date = datetime.datetime.strptime(pub_date_str[:25], "%a, %d %b %Y %H:%M:%S")
                          diff_minutes = (now - pub_date).total_seconds() / 60
                          if diff_minutes < 60:
                              real_count += 1
                      except:
                          continue # Hoppa över datum som inte går att läsa

                  post_count_last_hour = real_count
                  status = "live"
                  fetched_success = True
                  print(f"SUCCESS Proxy 1: Hittade {real_count} inlägg senaste timmen.")

              except Exception as e:
                  print(f"Proxy 1 misslyckades: {e}")

          # --- FÖRSÖK 2: RSS2JSON (JSON Backup) ---
          if not fetched_success:
              try:
                  print("Testar Proxy 2 (RSS2JSON)...")
                  req = urllib.request.Request(proxy_2, headers={'User-Agent': 'Mozilla/5.0'})
                  response = urllib.request.urlopen(req, timeout=30)
                  data = json.loads(response.read())
                  
                  real_count = 0
                  if 'items' in data:
                      for item in data['items']:
                          try:
                              pub_date_str = item['pubDate']
                              pub_date = datetime.datetime.strptime(pub_date_str, "%Y-%m-%d %H:%M:%S")
                              diff_minutes = (now - pub_date).total_seconds() / 60
                              if diff_minutes < 60:
                                  real_count += 1
                          except:
                              continue

                  post_count_last_hour = real_count
                  status = "live"
                  fetched_success = True
                  print(f"SUCCESS Proxy 2: Hittade {real_count} inlägg senaste timmen.")

              except Exception as e:
                  print(f"Proxy 2 misslyckades: {e}")

          # --- OM BÅDA MISSLYCKAS: SIMULERING ---
          if not fetched_success:
              print("ALLA metoder blockerade/timeout. Kör simulering.")
              status = "estimated"
              # Viktad slump: 70% chans för 0 inlägg (Tystnad är mest sannolikt)
              roll = random.randint(0, 100)
              if roll < 70: post_count_last_hour = 0
              elif roll < 90: post_count_last_hour = 1
              else: post_count_last_hour = random.randint(2, 5)

          # Spara data
          output = {
              "postCount": post_count_last_hour,
              "status": status,
              "lastUpdated": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          }

          with open('data.json', 'w') as f:
              json.dump(output, f)
          EOF

          python analyzer.py

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Real-time Intelligence Analysis" || exit 0
          git push
