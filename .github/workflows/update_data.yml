name: Update Trump Data
on:
  schedule:
    - cron: '*/30 * * * *' # Körs var 30:e minut
  workflow_dispatch: # Tillåter manuell körning

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Data (Multi-Strategy)
        run: |
          # --- STRATEGI 1: AllOrigins Proxy (Oftast säkrast) ---
          echo "Testar Strategi 1: AllOrigins Proxy..."
          PROXY_DATA=$(curl -s "https://api.allorigins.win/get?url=https://truthsocial.com/@realDonaldTrump.rss")
          # AllOrigins returnerar JSON med RSS-texten i fältet "contents". Vi letar efter <item> där i.
          COUNT_1=$(echo "$PROXY_DATA" | grep -o "<item>" | wc -l)
          
          if [ "$COUNT_1" -gt "0" ]; then
            COUNT=$COUNT_1
            STATUS="live"
            METHOD="Proxy (AllOrigins)"
            echo "Lyckades via Proxy! Antal inlägg: $COUNT"
          else
            # --- STRATEGI 2: Direkt anrop med 'Firefox'-maskering ---
            echo "Proxy misslyckades. Testar Strategi 2: Direkt Firefox-maskering..."
            
            # Vi fejkar en riktig Firefox-webbläsare med alla headers
            USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0"
            ACCEPT="text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
            
            DIRECT_DATA=$(curl -s -L -H "User-Agent: $USER_AGENT" -H "Accept: $ACCEPT" --max-time 15 "https://truthsocial.com/@realDonaldTrump.rss")
            COUNT_2=$(echo "$DIRECT_DATA" | grep -o "<item>" | wc -l)
            
            if [ "$COUNT_2" -gt "0" ]; then
              COUNT=$COUNT_2
              STATUS="live"
              METHOD="Direct (Masked)"
              echo "Lyckades via Direktmaskering! Antal inlägg: $COUNT"
            else
              # --- FALLBACK: Om ALLT misslyckas ---
              # Vi måste simulera för att inte krascha sidan, men vi vet nu att det är en simulering.
              COUNT=$(( ( RANDOM % 10 ) + 5 ))
              STATUS="simulated"
              METHOD="Simulation (Blocked)"
              echo "ALLA metoder blockerade. Kör simulering."
            fi
          fi
          
          # Skapa JSON-filen
          TIMESTAMP=$(date -u)
          echo "{\"postCount\": $COUNT, \"status\": \"$STATUS\", \"method\": \"$METHOD\", \"lastUpdated\": \"$TIMESTAMP\"}" > data.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Update Intelligence: $STATUS via $METHOD" || exit 0
          git push
