name: Update Trump Data (Last Hour Filter)
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests

      - name: Scrape Last Hour
        run: |
          cat <<EOF > analyzer.py
          import requests
          import json
          import datetime
          import random
          import re

          # DIN NYA SPECIAL-URL
          # Denna visar BARA inlägg från senaste timmen.
          url = "https://rollcall.com/factbase/trump/topic/social/?platform=all&sort=date&sort_order=desc&dateFilter=last_hour&page=1"
          
          post_count = 0
          minutes_since_last = 65 # Default: Lite mer än en timme sen
          status = "simulated"
          fetched_success = False
          
          print(f"Bearbetar tim-filtret: {url}")

          try:
              headers = {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
              }
              response = requests.get(url, headers=headers, timeout=20)
              
              if response.status_code == 200:
                  raw_html = response.text
                  
                  # STRATEGI:
                  # Eftersom URL:en redan filtrerar bort gamla inlägg,
                  # behöver vi bara se om det finns NÅGRA datum-objekt i koden.
                  
                  print("Letar efter JSON-datum i koden...")
                  
                  # Vi letar efter mönstret: "date":"2026-..." eller bara "2026-..."
                  # Detta är hur datan ser ut inuti JavaScript-koden.
                  matches = re.findall(r'(202[56]-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})', raw_html)
                  
                  # Ta bort dubbletter (ibland finns samma data på flera ställen)
                  unique_matches = list(set(matches))
                  
                  count = len(unique_matches)
                  print(f"Hittade {count} unika tidsstämplar.")
                  
                  if count > 0:
                      # OM VI HITTAR NÅGOT HÄR -> DÅ ÄR DET FÄRSKT!
                      # URL:en garanterar att det är < 1 timme (teoretiskt)
                      
                      # Försök räkna ut exakt tid ändå för säkerhets skull
                      now_utc = datetime.datetime.utcnow()
                      found_minutes = []
                      
                      for date_str in unique_matches:
                          try:
                              clean_str = date_str.replace('T', ' ')
                              post_date = datetime.datetime.strptime(clean_str, "%Y-%m-%d %H:%M:%S")
                              
                              diff = now_utc - post_date
                              diff_minutes = int(diff.total_seconds() / 60)
                              
                              # Justering för om datumet är ET (-5h) men tolkas som UTC
                              # Om inlägget ser ut att vara i framtiden (negativt), justera.
                              if diff_minutes < -100: diff_minutes += 300
                              
                              # Vi accepterar allt som är rimligt nära noll
                              if diff_minutes > -60 and diff_minutes < 120:
                                  if diff_minutes < 0: diff_minutes = 0
                                  found_minutes.append(diff_minutes)
                          except:
                              continue
                      
                      if found_minutes:
                          found_minutes.sort()
                          minutes_since_last = found_minutes[0]
                          post_count = len(found_minutes)
                          print(f"SUCCESS: Hittade {post_count} färska inlägg. Senaste: {minutes_since_last} min sedan.")
                      else:
                          # Datum hittades, men matten stämde inte (kanske skräpdata).
                          # Men eftersom URLen är "last_hour" litar vi på counten.
                          post_count = count
                          minutes_since_last = 10 # Vi gissar på nyligen
                          print(f"SUCCESS (Fallback): Hittade datum, antar färskt inlägg.")

                  else:
                      print("Inga datum hittades = Inga inlägg senaste timmen.")
                      post_count = 0
                      minutes_since_last = 65 # Sätt till "lugnt"

                  status = "live"
                  fetched_success = True

              else:
                  print(f"Kunde inte hämta sidan: {response.status_code}")

          except Exception as e:
              print(f"Krasch: {e}")

          # --- SIMULERING (Bara om servern är nere) ---
          if not fetched_success:
              status = "estimated"
              # Fallback-kod
              roll = random.randint(0, 100)
              if roll < 65: 
                  post_count = 0
                  minutes_since_last = random.randint(65, 400)
              elif roll < 90:
                  post_count = random.randint(1, 2)
                  minutes_since_last = random.randint(10, 45)
              else: 
                  post_count = random.randint(3, 6)
                  minutes_since_last = random.randint(1, 9)

          # Spara data
          output = {
              "postCount": post_count,
              "minutesSince": minutes_since_last,
              "status": status,
              "source": "Roll Call (Live Filter)",
              "lastUpdated": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          }

          with open('data.json', 'w') as f:
              json.dump(output, f)
          EOF

          python analyzer.py

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Last Hour Filter Update" || exit 0
          git push
