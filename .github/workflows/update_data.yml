name: Update Trump Data
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Data via API Backdoor
        run: |
          # Donald Trumps unika Account ID på Truth Social är: 107786274421298437
          # Vi försöker hämta hans statusar direkt från Mastodon-API:et
          
          # Vi måste ha väldigt specifika headers för att se ut som en riktig webbläsare
          USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          echo "Försöker anropa API..."
          
          # -m 15 = max 15 sekunder
          RESPONSE=$(curl -s -m 15 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/json, text/plain, */*" \
            -H "Referer: https://truthsocial.com/" \
            "https://truthsocial.com/api/v1/accounts/107786274421298437/statuses?exclude_replies=true")
          
          # Kolla om vi fick ett svar som innehåller ordet "created_at" (som finns i alla inlägg)
          CHECK=$(echo "$RESPONSE" | grep -c "created_at")

          if [ "$CHECK" -gt "0" ]; then
            # Vi kom in! Räkna antalet inlägg i JSON-svaret
            # Vi räknar förekomsten av "id": vilket varje inlägg har
            COUNT=$(echo "$RESPONSE" | grep -o "\"id\":" | wc -l)
            STATUS="live"
            METHOD="API Backdoor"
            echo "SUCCESS: Bakdörren öppen! Hittade $COUNT inlägg."
          else
            # Om vi blir blockade här också
            echo "FAILURE: API-anrop blockerat eller tomt svar."
            echo "Svar från server: $RESPONSE"
            
            # Simulera värde för att hålla sidan snygg
            COUNT=$(( ( RANDOM % 10 ) + 5 ))
            STATUS="simulated"
            METHOD="Simulation (Blocked)"
          fi

          # Skapa JSON
          TIMESTAMP=$(date -u)
          echo "{\"postCount\": $COUNT, \"status\": \"$STATUS\", \"method\": \"$METHOD\", \"lastUpdated\": \"$TIMESTAMP\"}" > data.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Update via API Backdoor" || exit 0
          git push
