name: Update Trump Data
on:
  schedule:
    - cron: '*/30 * * * *' # Körs varje halvtimme
  workflow_dispatch: # Manuell körning

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run Intelligence Engine
        run: |
          cat <<EOF > analyzer.py
          import urllib.request
          import json
          import datetime
          import random
          from xml.dom import minidom
          import ssl

          # Ignorera SSL-certifikatfel
          ssl._create_default_https_context = ssl._create_unverified_context

          # Vi testar EN proxy som ibland fungerar (rss2json)
          proxy_url = "https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Ftruthsocial.com%2F%40realDonaldTrump.rss"
          
          post_count_last_hour = 0
          status = "simulated" # Utgår från simulering
          fetched_success = False
          
          now = datetime.datetime.utcnow()
          print(f"Tid (UTC): {now}")

          # --- FÖRSÖK HÄMTA ÄKTA DATA ---
          try:
              print("Försöker hämta via Proxy...")
              # 10 sekunders timeout
              req = urllib.request.Request(proxy_url, headers={'User-Agent': 'Mozilla/5.0'})
              response = urllib.request.urlopen(req, timeout=10)
              data = json.loads(response.read())
              
              if 'items' in data:
                  real_count = 0
                  for item in data['items']:
                      try:
                          # Försök läsa datum
                          pub_date_str = item.get('pubDate', '')
                          # Formatet brukar vara "YYYY-MM-DD HH:MM:SS" hos rss2json
                          pub_date = datetime.datetime.strptime(pub_date_str, "%Y-%m-%d %H:%M:%S")
                          
                          # Räkna skillnad i minuter
                          diff_minutes = (now - pub_date).total_seconds() / 60
                          
                          if diff_minutes < 60:
                              real_count += 1
                      except Exception as e:
                          continue 

                  post_count_last_hour = real_count
                  status = "live"
                  fetched_success = True
                  print(f"SUCCESS: Hittade {real_count} äkta inlägg.")
              else:
                  print("Proxyn svarade, men inga 'items' hittades.")

          except Exception as e:
              print(f"Blockerad/Fel vid hämtning: {e}")

          # --- SIMULERINGS-MOTOR (Fail-Safe) ---
          if not fetched_success:
              print("Kör statistisk simulering.")
              status = "estimated"
              
              # Vår kalibrerade sannolikhet för Trump:
              # 65% chans: Han sover/gör annat (0 inlägg) -> Index 87%
              # 25% chans: Normalt gnäll (1-2 inlägg) -> Index sjunker
              # 10% chans: Utbrott (3+ inlägg) -> Index kraschar
              
              roll = random.randint(0, 100)
              
              if roll < 65:
                  post_count_last_hour = 0
              elif roll < 90:
                  post_count_last_hour = random.randint(1, 2)
              else:
                  post_count_last_hour = random.randint(3, 6)

          # Spara resultatet
          output = {
              "postCount": post_count_last_hour,
              "status": status,
              "lastUpdated": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          }

          with open('data.json', 'w') as f:
              json.dump(output, f)
          EOF

          python analyzer.py

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          git commit -m "Data Update" || exit 0
          git push
