name: Update Trump Data
on:
  schedule:
    - cron: '*/30 * * * *' # Körs var 30:e minut
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Data (Bulletproof Strategy)
        run: |
          # Vi försöker hämta via AllOrigins (en snäll proxy)
          # "|| echo" gör att scriptet INTE kraschar om det misslyckas
          RAW_DATA=$(curl -s --max-time 10 "https://api.allorigins.win/get?url=https://truthsocial.com/@realDonaldTrump.rss" || echo "")
          
          # Vi letar efter <item> i svaret
          COUNT=$(echo "$RAW_DATA" | grep -o "<item>" | wc -l || echo "0")
          
          # Logik: Om vi fick data -> LIVE. Annars -> ESTIMATED.
          if [ "$COUNT" -gt "0" ]; then
            STATUS="live"
            METHOD="Proxy Success"
            echo "Lyckades! Äkta data hämtad: $COUNT inlägg."
          else
            # Om vi blir blockade (vilket är troligt), simulera ett värde
            # Slumptal mellan 5 och 14
            COUNT=$(( ( RANDOM % 10 ) + 5 ))
            STATUS="simulated"
            METHOD="Simulation (Blocked by Truth Social)"
            echo "Kunde inte nå källan (IP Block). Kör simulering: $COUNT inlägg."
          fi
          
          # Skapa tidsstämpel
          TIMESTAMP=$(date -u)
          
          # Spara JSON-filen som hemsidan läser
          echo "{\"postCount\": $COUNT, \"status\": \"$STATUS\", \"method\": \"$METHOD\", \"lastUpdated\": \"$TIMESTAMP\"}" > data.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data.json
          # Commit endast om något ändrats, krascha inte om det är tomt
          git commit -m "Intelligence Update: $STATUS" || exit 0
          git push
